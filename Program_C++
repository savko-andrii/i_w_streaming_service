#include <iostream>
#include <fstream>
#include <string>
#include <stdexcept>
using namespace std;

// Абстрактний клас
class Playable {
public:
    virtual void showInfo() const = 0;   // чисто віртуальний метод
    virtual void saveToFile(ofstream& fout) const = 0;
    virtual ~Playable() {}
};

// Клас Song успадковує Playable
class Song : public Playable {
private:
    string title;
    string artist;
    int duration;
    static int songCount;   // статична змінна

public:
    Song(string t, string a, int d) {
        if (d <= 0) throw invalid_argument("Duration must be positive!");
        title = t;
        artist = a;
        duration = d;
        songCount++;
    }

    void showInfo() const override {
        cout << title << " — " << artist << " (" << duration << " sec)\n";
    }

    void saveToFile(ofstream& fout) const override {
        fout << title << "\n" << artist << "\n" << duration << "\n";
    }

    static int getSongCount() { return songCount; }
};

int Song::songCount = 0;

// Клас Playlist
class Playlist {
private:
    string filename;

public:
    Playlist(string fn) : filename(fn) {
        ofstream f(filename, ios::app);
        if (!f.is_open()) throw runtime_error("Cannot open file!");
    }

    void addSong(const Song& s) {
        ofstream fout(filename, ios::app);
        if (!fout.is_open()) throw runtime_error("Cannot write to file!");
        s.saveToFile(fout);
        fout.close();
        cout << "Song added successfully.\n";
    }

    void showAll() {
        ifstream fin(filename);
        if (!fin.is_open()) throw runtime_error("Cannot read file!");

        string title, artist;
        int duration;
        int i = 1;
        cout << "=== Playlist ===\n";
        while (getline(fin, title)) {
            if (title.empty()) continue;
            getline(fin, artist);
            fin >> duration;
            fin.ignore();
            try {
                Song s(title, artist, duration);
                cout << i++ << ". ";
                s.showInfo(); // поліморфний виклик
            }
            catch (exception& e) {
                cout << "Bad song data: " << e.what() << "\n";
            }
        }
        cout << "Total songs: " << Song::getSongCount() << "\n";
        fin.close();
    }
};

// Основна програма
int main() {
    const string filename = "songs.txt";

    try {
        Playlist pl(filename);

        cout << "Choose mode:\n";
        cout << "1 — Author (add new songs)\n";
        cout << "2 — Listener (view playlist)\n";
        cout << "Your choice: ";

        int mode;
        if (!(cin >> mode)) throw runtime_error("Invalid input!");
        cin.ignore();

        if (mode == 1) {
            while (true) {
                string title, artist;
                int duration;

                cout << "Song title: ";
                getline(cin, title);
                cout << "Artist: ";
                getline(cin, artist);
                cout << "Duration (sec): ";
                while (!(cin >> duration)) {
                    cin.clear();
                    string bad;
                    getline(cin, bad);
                    cout << "Invalid input. Enter duration in seconds: ";
                }
                cin.ignore();

                Song s(title, artist, duration);
                pl.addSong(s);

                cout << "Add another song? (y/n): ";
                char c;
                cin >> c;
                cin.ignore();
                if (!(c == 'y' || c == 'Y')) break;
            }
        }
        else if (mode == 2) {
            pl.showAll();
        }
        else {
            cout << "Invalid option.\n";
        }

        cout << "Program finished.\n";
    }
    catch (exception& e) {
        cerr << "ERROR: " << e.what() << "\n";
        return 1;
    }
    return 0;
}
