#include <iostream>
#include <string>
#include <vector>
#include <fstream>
using namespace std;

// -----------------------------
// Кастомні винятки
// -----------------------------
class FileOpenError {};
class InvalidDuration {};

// -----------------------------
// Абстрактний клас
// -----------------------------
class AudioContent {
protected:
    string title;
    int duration;
    static int totalPlays; // статична змінна

public:
    AudioContent(string t = "", int d = 0) {
        if (d < 0) throw InvalidDuration();
        title = t;
        duration = d;
    }

    virtual ~AudioContent() {}

    virtual void play() = 0; // поліморфізм

    static int getTotalPlays() {
        return totalPlays;
    }

    virtual void saveToFile(ofstream& out) {
        out << title << endl;
        out << duration << endl;
    }

    virtual void loadFromFile(ifstream& in) {
        getline(in, title);
        in >> duration;
        in.ignore();
    }
};

int AudioContent::totalPlays = 0;

// -----------------------------
// Клас Song
// -----------------------------
class Song : public AudioContent {
    string artist;

public:
    Song(string t = "", int d = 0, string a = "") 
        : AudioContent(t, d), artist(a) {}

    void play() override {
        totalPlays++;
        cout << "Playing song: " << title 
             << " by " << artist 
             << " (" << duration << "s)" << endl;
    }

    void saveToFile(ofstream& out) override {
        out << "SONG" << endl;
        AudioContent::saveToFile(out);
        out << artist << endl;
    }

    void loadFromFile(ifstream& in) override {
        AudioContent::loadFromFile(in);
        getline(in, artist);
    }
};

// -----------------------------
// Клас PodcastEpisode
// -----------------------------
class PodcastEpisode : public AudioContent {
    string host;

public:
    PodcastEpisode(string t = "", int d = 0, string h = "")
        : AudioContent(t, d), host(h) {}

    void play() override {
        totalPlays++;
        cout << "Playing podcast: " << title 
             << " host " << host 
             << " (" << duration << "s)" << endl;
    }

    void saveToFile(ofstream& out) override {
        out << "PODCAST" << endl;
        AudioContent::saveToFile(out);
        out << host << endl;
    }

    void loadFromFile(ifstream& in) override {
        AudioContent::loadFromFile(in);
        getline(in, host);
    }
};

// -----------------------------
// Клас AudioBook
// -----------------------------
class AudioBook : public AudioContent {
    string author;

public:
    AudioBook(string t = "", int d = 0, string a = "")
        : AudioContent(t, d), author(a) {}

    void play() override {
        totalPlays++;
        cout << "Playing audiobook: " << title 
             << " by " << author 
             << " (" << duration << "s)" << endl;
    }

    void saveToFile(ofstream& out) override {
        out << "AUDIOBOOK" << endl;
        AudioContent::saveToFile(out);
        out << author << endl;
    }

    void loadFromFile(ifstream& in) override {
        AudioContent::loadFromFile(in);
        getline(in, author);
    }
};

// -----------------------------
// Збереження плейліста
// -----------------------------
void savePlaylist(vector<AudioContent*>& list, string filename) {
    ofstream out(filename);
    if (!out.is_open()) throw FileOpenError();

    for (int i = 0; i < list.size(); i++) {
        list[i]->saveToFile(out);
    }

    out.close();
}

// -----------------------------
// Завантаження плейліста
// -----------------------------
vector<AudioContent*> loadPlaylist(string filename) {
    ifstream in(filename);
    if (!in.is_open()) throw FileOpenError();

    vector<AudioContent*> result;
    string type;

    while (getline(in, type)) {
        AudioContent* ptr = nullptr;

        if (type == "SONG")
            ptr = new Song();
        else if (type == "PODCAST")
            ptr = new PodcastEpisode();
        else if (type == "AUDIOBOOK")
            ptr = new AudioBook();
        else
            continue;

        ptr->loadFromFile(in);
        result.push_back(ptr);
    }

    in.close();
    return result;
}

// -----------------------------
// Головна програма
// -----------------------------
int main() {
    try {
        vector<AudioContent*> playlist;

        playlist.push_back(new Song("Numb", 185, "Linkin Park"));
        playlist.push_back(new PodcastEpisode("C++ Talk", 1200, "Jason"));
        playlist.push_back(new AudioBook("The Hobbit", 3600, "Tolkien"));

        cout << "=== Playing playlist ===" << endl;
        for (int i = 0; i < playlist.size(); i++)
            playlist[i]->play();

        cout << "\nTotal plays: " << AudioContent::getTotalPlays() << endl;

        savePlaylist(playlist, "playlist.txt");
        cout << "Playlist saved!\n";

        // очистимо
        for (auto p : playlist) delete p;
        playlist.clear();

        cout << "\nLoading playlist...\n";
        playlist = loadPlaylist("playlist.txt");

        for (int i = 0; i < playlist.size(); i++)
            playlist[i]->play();

        cout << "\nTotal plays: " << AudioContent::getTotalPlays() << endl;

        for (auto p : playlist) delete p;

    } catch (FileOpenError) {
        cout << "File error!" << endl;
    } catch (InvalidDuration) {
        cout << "Invalid duration!" << endl;
    }

    return 0;
}
